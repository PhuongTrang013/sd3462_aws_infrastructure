pipeline {
    agent any

    environment {
        KUBECONFIG_CREDENTIALS_ID = 'kubeconfig-credentials-id'
        KUBE_NAMESPACE = 'ingress-nginx'
        ECR_REPO = '905418472653.dkr.ecr.us-east-1.amazonaws.com/practical-devops'
        KUBECONFIG = "/var/lib/jenkins/.kube/config" //locate in jenkins EC2 serevr
    }
   
    stages {
        stage('Create Namespace on EKS') {
            steps {
                script {
                    withCredentials([file(credentialsId: "${KUBECONFIG_CREDENTIALS_ID}", variable: 'KUBECONFIG')]) {
                        sh "kubectl create namespace ${KUBE_NAMESPACE} || echo 'Namespace already exists'"
                    }
                }
            }
        }

        stage('Update Image Tag') {
            steps {
                script {
                    sh """
                    # Update image tag in the manifest files
                    find ${env.WORKSPACE}/eks-deploy/manifest/ -type f -name '*.yaml' -exec sed -i 's|image: ${ECR_REPO}:.*|image: ${ECR_REPO}:${IMAGE_TAG}|g' {} +
                    """
                }
            }
        }
        
        stage('Deploy to EKS') {
            steps {
                script {
                    withCredentials([file(credentialsId: "${KUBECONFIG_CREDENTIALS_ID}", variable: 'KUBECONFIG')]) {
                        sh "kubectl apply -f ${env.WORKSPACE}/eks-deploy/manifest/ --namespace=${KUBE_NAMESPACE}"
                    }
                }
            }
        }
    }
}
